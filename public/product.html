<!DOCTYPE html>
<html>
<head>
    <title>Detalle del Producto - Belleza Eva</title>
    <link 
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark">
    <div class="container">
        <a href="products.html" class="navbar-brand">← Volver</a>
    </div>
</nav>

<div class="container mt-4">

    <!-- PRODUCTO -->
    <div id="productDetail" class="mb-4"></div>

    <!-- COMENTARIOS -->
    <h4>Comentarios</h4>
    <ul id="commentsList" class="list-group mb-3"></ul>

    <!-- FORMULARIO -->
    <textarea id="commentText" class="form-control mb-2"
        placeholder="Escribe tu comentario (máximo 200 caracteres)"
        maxlength="200"></textarea>
    
    <div class="mb-2">
        <small class="text-muted">
            <span id="charCount">0</span>/200 caracteres
        </small>
    </div>

    <button class="btn btn-primary" onclick="addComment()">
        Agregar comentario
    </button>

</div>

<script>
const params = new URLSearchParams(window.location.search);
const productId = params.get("id");
const commentTextarea = document.getElementById("commentText");
const charCountSpan = document.getElementById("charCount");

// Actualizar contador de caracteres
commentTextarea.addEventListener("input", function() {
    charCountSpan.textContent = this.value.length;
});

// Cargar producto
fetch(`http://127.0.0.1:8000/api/products/${productId}`)
.then(res => res.json())
.then(p => {
    document.getElementById("productDetail").innerHTML = `
        <div class="card">
            <img src="${p.image_url || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22600%22 height=%22400%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22600%22 height=%22400%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 font-family=%22Arial%22 font-size=%2230%22 fill=%22%23999%22%3EImagen del producto%3C/text%3E%3C/svg%3E'}" 
                 class="card-img-top" 
                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22600%22 height=%22400%22%3E%3Crect fill=%22%23ffebee%22 width=%22600%22 height=%22400%22/%3E%3Ctext x=%2250%25%22 y=%2245%25%22 text-anchor=%22middle%22 font-family=%22Arial%22 font-size=%2224%22 fill=%22%23d32f2f%22%3E❌ Imagen no disponible%3C/text%3E%3Ctext x=%2250%25%22 y=%2255%25%22 text-anchor=%22middle%22 font-family=%22Arial%22 font-size=%2218%22 fill=%22%23d32f2f%22%3E(Error al cargar)%3C/text%3E%3C/svg%3E'"
                 style="height:300px;object-fit:cover;">
            <div class="card-body">
                <h3>${p.name}</h3>
                <p>${p.description}</p>
                <p class="fw-bold">$${p.price}</p>
            </div>
        </div>
    `;
});

// Cargar comentarios
fetch(`http://127.0.0.1:8000/api/comments/product/${productId}`)
.then(res => res.json())
.then(comments => {
    let html = "";
    if (comments.length === 0) {
        html = '<li class="list-group-item text-muted">No hay comentarios aún. ¡Sé el primero!</li>';
    } else {
        comments.forEach(c => {
            const commentText = c.text || '';
            const createdAt = new Date(c.created_at).toLocaleDateString('es-ES');
            html += `
                <li class="list-group-item">
                    <div>
                        <strong>${c.user_name}</strong>
                        <small class="text-muted float-end">${createdAt}</small>
                    </div>
                    <p class="mb-0 mt-2">${commentText}</p>
                </li>
            `;
        });
    }
    document.getElementById("commentsList").innerHTML = html;
})
.catch(err => {
    console.error("Error cargando comentarios:", err);
    document.getElementById("commentsList").innerHTML = '<li class="list-group-item text-danger">Error al cargar comentarios</li>';
});

// Agregar comentario
function addComment() {
    const text = document.getElementById("commentText").value.trim();
    const token = localStorage.getItem("token");

    // Validaciones
    if (!token) {
        alert("Debes estar registrado para comentar. Por favor, inicia sesión.");
        window.location.href = "index.html";
        return;
    }

    if (!text) {
        alert("El comentario no puede estar vacío");
        return;
    }

    if (text.length > 200) {
        alert("El comentario no puede exceder 200 caracteres");
        return;
    }

    // Enviar comentario
    fetch("http://127.0.0.1:8000/api/comments", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({
            product_id: productId,
            text: text
        })
    })
    .then(res => {
        console.log('Response status:', res.status);
        return res.json().then(data => ({status: res.status, data}));
    })
    .then(({status, data}) => {
        if (status === 401) {
            alert("Tu sesión expiró. Por favor, inicia sesión de nuevo.");
            localStorage.removeItem("token");
            localStorage.removeItem("userData");
            window.location.href = "index.html";
            return;
        }
        
        if (status === 201 || (data && data.message)) {
            document.getElementById("commentText").value = "";
            charCountSpan.textContent = "0";
            alert("✅ Comentario agregado exitosamente");
            setTimeout(() => location.reload(), 500);
        } else {
            alert("❌ Error: " + (data.message || 'Error desconocido'));
            console.log('Error details:', data);
        }
    })
    .catch(err => {
        console.error("Error:", err);
        alert("❌ Error al agregar comentario: " + err.message);
    });
}
</script>

</body>
</html>
